#!/usr/bin/env bash

set -euo pipefail

configuration_name="${1:-$CFG_NAME}"
echo "Applying configuration for $configuration_name"

script_dir="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")" )"
cfg_home="$(realpath "${script_dir}/../..")"

cd "$cfg_home"

nix run .#stow -- .

git_config_author_email_command=(
  nix run .#git -- config --file ~/.config/git/config.local user.email
)

if ! "${git_config_author_email_command[@]}" > /dev/null
then
  echo "⚠️ No git author configured yet."
  read -p "Enter git author email addres (leave empty to skip): " email

  if [ -n "$email" ]
  then
    "${git_config_author_email_command[@]}" "$email"
  fi
fi

sudo -i nix run "${cfg_home}#rebuild" -- switch --flake "${cfg_home}#$configuration_name"
